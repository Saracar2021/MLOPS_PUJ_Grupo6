# ====================================================================
# NGINX Configuration - Load Balancer para API de Inferencia
# Taller 5 - Locust
# ====================================================================

events {
    worker_connections 1024;
}

http {
    # Configuración de upstream (backend servers)
    upstream inference_backend {
        # Estrategia de balanceo: Round Robin (por defecto)
        # Otras opciones: least_conn, ip_hash, random
        
        # Docker Compose crea automáticamente estas entradas DNS
        # cuando escalas el servicio
        server inference_api:8989 max_fails=3 fail_timeout=30s;
        
        # Keepalive para mejorar rendimiento
        keepalive 32;
    }

    # Configuración del servidor
    server {
        listen 80;
        server_name localhost;

        # Timeouts
        proxy_connect_timeout 10s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;

        # Buffers
        proxy_buffering on;
        proxy_buffer_size 4k;
        proxy_buffers 8 4k;
        proxy_busy_buffers_size 8k;

        # Headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Keepalive
        proxy_http_version 1.1;
        proxy_set_header Connection "";

        # Location para todos los endpoints
        location / {
            proxy_pass http://inference_backend;
        }

        # Location específico para health check
        location /health {
            proxy_pass http://inference_backend/health;
            access_log off;  # No logear health checks
        }

        # Location para métricas
        location /metrics {
            proxy_pass http://inference_backend/metrics;
        }

        # Status de NGINX (opcional, útil para debugging)
        location /nginx_status {
            stub_status on;
            access_log off;
        }
    }

    # Configuración de logs
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log warn;

    # Optimizaciones generales
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;
}

# ====================================================================
# ESTRATEGIAS DE BALANCEO DISPONIBLES:
# ====================================================================
# 
# 1. Round Robin (por defecto):
#    upstream inference_backend {
#        server inference_api:8989;
#    }
#
# 2. Least Connections (menos conexiones activas):
#    upstream inference_backend {
#        least_conn;
#        server inference_api:8989;
#    }
#
# 3. IP Hash (mismo cliente, mismo servidor):
#    upstream inference_backend {
#        ip_hash;
#        server inference_api:8989;
#    }
#
# 4. Weighted (pesos diferentes):
#    upstream inference_backend {
#        server inference_api_1:8989 weight=3;
#        server inference_api_2:8989 weight=1;
#    }
# ====================================================================
